<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AJIS — Admin Dashboard</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #ef4444;
      --muted: #98a0ab;
    }

    body {
      margin: 0;
      font-family: Inter, sans-serif;
      background: linear-gradient(180deg, #071427, #081226);
      color: #e6eef6;
      min-height: 100vh;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 30px;
    }

    .brand .logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--accent);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
    }

    .nav-item {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-item.active {
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent);
    }

    .main {
      flex: 1;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 20px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .table th {
      color: var(--muted);
      font-weight: 500;
      font-size: 14px;
    }

    .btn {
      padding: 8px 16px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #d63031;
    }

    /* Dashboard Styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .stat-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15);
    }

    .stat-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
    }

    .stat-content {
      flex: 1;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }

    .charts-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
    }

    .chart-container h3 {
      margin: 0 0 20px 0;
      color: #e6eef6;
      font-size: 18px;
      font-weight: 600;
    }

    canvas {
      max-width: 100%;
      height: auto;
    }

    /* Car Card Styles */
    .car-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .car-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15);
    }

    .car-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
    }

    .car-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .car-info {
      margin-bottom: 15px;
    }

    .car-name {
      font-size: 18px;
      font-weight: 700;
      color: #e6eef6;
      margin-bottom: 8px;
    }

    .car-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .car-detail {
      font-size: 14px;
      color: var(--muted);
    }

    .car-detail strong {
      color: #e6eef6;
    }

    .car-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .car-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-available {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-reserved {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .status-rented {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .car-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .car-actions .btn {
      flex: 1;
      padding: 8px 12px;
      font-size: 12px;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 0;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      color: #e6eef6;
      font-size: 20px;
      font-weight: 600;
    }

    .close {
      color: var(--muted);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close:hover {
      color: #e6eef6;
    }

    .form-group {
      margin-bottom: 20px;
      padding: 0 20px;
    }

    .form-group:first-of-type {
      padding-top: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #e6eef6;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: #e6eef6;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input[type="file"] {
      padding: 8px;
      cursor: pointer;
    }

    .form-group input[type="file"]::-webkit-file-upload-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .form-group input[type="file"]::-webkit-file-upload-button:hover {
      background: #d63031;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input::placeholder {
      color: var(--muted);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary {
      background: #6b7280;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api.js"></script>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <div class="brand">
        <div class="logo">A</div>
        <div>AJIS Car Rental</div>
      </div>

      <div class="nav-item active">Dashboard</div>
      <div class="nav-item">Users</div>
      <div class="nav-item">Customers</div>
      <div class="nav-item">Cars</div>
      <div class="nav-item" id="rent-nav">Rent</div>
      <div class="nav-item">Bookings</div>
      <div class="nav-item" id="logout-btn">Logout</div>
    </div>

    <div class="main">
      <div class="header">
        <h1>Admin Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 15px">
          <div id="admin-name">Admin</div>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div class="card" id="dashboard-section">
        <h2>Dashboard Overview</h2>
        <div class="stats-grid">
          <div class="stat-card" onclick="showSection('cars')">
            <div class="stat-icon">🚗</div>
            <div class="stat-content">
              <div class="stat-number" id="total-cars">0</div>
              <div class="stat-label">Total Cars</div>
            </div>
          </div>
          <div class="stat-card" onclick="showSection('customers')">
            <div class="stat-icon">👥</div>
            <div class="stat-content">
              <div class="stat-number" id="total-customers">0</div>
              <div class="stat-label">Total Customers</div>
            </div>
          </div>
          <!-- <div class="stat-card" onclick="showSection('bookings')">
              <div class="stat-icon">📋</div>
              <div class="stat-content">
                <div class="stat-number" id="total-reservations">0</div>
                <div class="stat-label">Total Reservations</div>
              </div>
            </div> -->
          <div class="stat-card" onclick="showSection('rent')">
            <div class="stat-icon">🔑</div>
            <div class="stat-content">
              <div class="stat-number" id="total-rents">0</div>
              <div class="stat-label">Total Rents</div>
            </div>
          </div>
          <div class="stat-card" onclick="showSection('sales')">
            <div class="stat-icon">💰</div>
            <div class="stat-content">
              <div class="stat-number" id="total-sales">₱0</div>
              <div class="stat-label">Total Sales</div>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section" style="grid-template-columns: 1fr">
          <div class="chart-container">
            <h3>Rental Trends</h3>
            <canvas id="rentalChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div class="card" id="users-section">
        <h2>Users Management</h2>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-list">
            <!-- Users will be loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Customers Section -->
      <div class="card" style="display: none" id="customers-section">
        <h2>Customers Management</h2>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Total Bookings</th>
              <th>Last Booking</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customers-list">
            <!-- Customers will be loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Cars Section -->
      <div class="card" style="display: none" id="cars-section">
        <h2>Cars Management</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button class="btn" onclick="showAddCarModal()">+ Add New Car</button>
        </div>

        <!-- Search and Filter Controls -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap">
          <input type="text" id="adminSearchBox" placeholder="Search cars..." style="
                flex: 1;
                min-width: 200px;
                padding: 8px 12px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 6px;
                background: rgba(255, 255, 255, 0.05);
                color: #e6eef6;
              " />
          <select id="adminCategoryFilter" style="
                padding: 8px 12px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 6px;
                background: rgba(255, 255, 255, 0.05);
                color: #e6eef6;
              ">
            <option value="all">All Categories</option>
            <option value="sedan">Sedan</option>
            <option value="suv">SUV</option>
            <option value="van">Van</option>
            <option value="luxury">Luxury</option>
          </select>
        </div>

        <!-- Cars Grid View (Customer Style) -->
        <div id="cars-grid" style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
              gap: 20px;
              margin-bottom: 20px;
            ">
          <!-- Cars will be loaded dynamically -->
        </div>

        <!-- Table View Toggle -->
        <div style="margin-bottom: 20px">
          <button class="btn" onclick="toggleCarView()" style="background: #6b7280">📋 Switch to Table View</button>
        </div>

        <!-- Table View (Hidden by default) -->
        <div id="cars-table-view" style="display: none">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Image</th>
                <th>Model</th>
                <th>Brand</th>
                <th>Type</th>
                <th>Seats</th>
                <th>Price/Day</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cars-list">
              <!-- Cars will be loaded dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rent Section -->
      <div class="card" style="display: none" id="rent-section">
        <h2>Car Rentals</h2>
        <p>View all customer car rentals and reservations.</p>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Car</th>
              <th>Plate</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rentals-list">
            <!-- Rentals will be loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Bookings Section -->
      <div class="card" style="display: none" id="bookings-section">
        <h2>Bookings Management</h2>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Car</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="bookings-list">
            <!-- Bookings will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Car Modal -->
  <div id="addCarModal" class="modal" style="display: none">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Car</h3>
        <span class="close" onclick="closeAddCarModal()">&times;</span>
      </div>
      <form id="addCarForm">
        <div class="form-group">
          <label for="carName">Car Name *</label>
          <input type="text" id="carName" name="name" required />
        </div>

        <div class="form-group">
          <label for="carPlate">Plate Number *</label>
          <input type="text" id="carPlate" name="plate" required />
        </div>

        <div class="form-group">
          <label for="carType">Transmission Type *</label>
          <select id="carType" name="type" required>
            <option value="">Select Type</option>
            <option value="Manual">Manual</option>
            <option value="Automatic">Automatic</option>
          </select>
        </div>

        <div class="form-group">
          <label for="carCategory">Category *</label>
          <select id="carCategory" name="category" required>
            <option value="">Select Category</option>
            <option value="sedan">Sedan</option>
            <option value="suv">SUV</option>
            <option value="van">Van</option>
            <option value="luxury">Luxury</option>
          </select>
        </div>

        <div class="form-group">
          <label for="carSeats">Number of Seats *</label>
          <input type="number" id="carSeats" name="seats" min="1" max="20" required />
        </div>

        <div class="form-group">
          <label for="carPrice">Price per Day (₱) *</label>
          <input type="number" id="carPrice" name="price" min="0" step="0.01" required />
        </div>

        <div class="form-group">
          <label for="carImage">Car Image</label>
          <input type="file" id="carImage" name="image" accept="image/*" />
          <small style="color: var(--muted); font-size: 12px; margin-top: 5px; display: block">
            Upload an image file (JPG, PNG, GIF) or leave empty for default
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddCarModal()">Cancel</button>
          <button type="submit" class="btn">Add Car</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check if user is logged in as admin
    document.addEventListener("DOMContentLoaded", function () {
      const userType = localStorage.getItem("userType");
      const userId = localStorage.getItem("userId");

      if (!userId || userType !== "admin") {
        alert("Access denied. Admin login required.");
        window.location.href = "login.html";
        return;
      }

      // Set admin name
      document.getElementById("admin-name").textContent = localStorage.getItem("userName") || "Admin";

      // Navigation functionality
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", function () {
          // Remove active class from all nav items
          document.querySelectorAll(".nav-item").forEach((nav) => nav.classList.remove("active"));
          // Add active class to clicked item
          this.classList.add("active");

          // Hide all sections
          document.querySelectorAll('[id$="-section"]').forEach((section) => {
            section.style.display = "none";
          });

          // Show selected section based on nav item text
          const navText = this.textContent.trim();
          if (navText === "Cars") {
            document.getElementById("cars-section").style.display = "block";
            loadCars();
          } else if (navText === "Rent") {
            document.getElementById("rent-section").style.display = "block";
            loadRentals();
          } else if (navText === "Bookings") {
            document.getElementById("bookings-section").style.display = "block";
            loadBookings();
          } else if (navText === "Users") {
            document.getElementById("users-section").style.display = "block";
            loadUsers();
          } else if (navText === "Customers") {
            document.getElementById("customers-section").style.display = "block";
            loadCustomers();
          } else if (navText === "Dashboard") {
            // Show dashboard section
            document.getElementById("dashboard-section").style.display = "block";
            updateDashboardStats();
          } else {
            // Default - show dashboard
            document.getElementById("dashboard-section").style.display = "block";
            updateDashboardStats();
          }
        });
      });

      // Load initial data
      loadUsers();

      // Initialize dashboard
      updateDashboardStats();
      initializeCharts();

      // Add car form submission
      document.getElementById("addCarForm").addEventListener("submit", function (e) {
        e.preventDefault();
        addCar();
      });

      // Close modal when clicking outside
      document.getElementById("addCarModal").addEventListener("click", function (e) {
        if (e.target === this) {
          closeAddCarModal();
        }
      });

      // Add search and filter event listeners for cars
      document.getElementById("adminSearchBox").addEventListener("input", () => {
        const cars = JSON.parse(localStorage.getItem("cars") || "[]");
        loadCarsGrid(cars);
      });

      document.getElementById("adminCategoryFilter").addEventListener("change", () => {
        const cars = JSON.parse(localStorage.getItem("cars") || "[]");
        loadCarsGrid(cars);
      });

      // Auto-refresh data every 2 seconds to show real-time updates
      setInterval(() => {
        loadCars();
        loadBookings();
        loadRentals();
        loadUsers();
        loadCustomers();
        updateDashboardStats();
      }, 2000);

      // Listen for localStorage changes from other tabs
      window.addEventListener("storage", (e) => {
        if (e.key === "cars" || e.key === "reservations") {
          loadCars();
          loadBookings();
          loadRentals();
          loadUsers();
          loadCustomers();
          updateDashboardStats();
        }
      });

      // Listen for custom events from customer page
      window.addEventListener("carStatusChanged", () => {
        loadCars();
        loadRentals();
        updateDashboardStats();
      });

      window.addEventListener("reservationAdded", () => {
        loadBookings();
        loadRentals();
        loadUsers();
        loadCustomers();
        updateDashboardStats();
      });

      // Logout button
      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("userId");
        localStorage.removeItem("userType");
        localStorage.removeItem("userName");
        window.location.href = "login.html";
      });
    });

    // Load customers from localStorage (customers who made reservations)
    function loadCustomers() {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const customersList = document.getElementById("customers-list");
      customersList.innerHTML = "";

      if (reservations.length === 0) {
        customersList.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: #98a0ab; padding: 20px;">
                No customers found. Customers will appear here when they make reservations.
              </td>
            </tr>
          `;
        return;
      }

      // Group reservations by customer email
      const customerMap = new Map();
      reservations.forEach((reservation) => {
        const email = reservation.email;
        if (!customerMap.has(email)) {
          customerMap.set(email, {
            name: reservation.name,
            email: reservation.email,
            phone: reservation.phone || "N/A",
            bookings: [],
          });
        }
        customerMap.get(email).bookings.push(reservation);
      });

      // Display customers
      let customerId = 1;
      customerMap.forEach((customer) => {
        const totalBookings = customer.bookings.length;
        const lastBooking = customer.bookings[customer.bookings.length - 1];
        const lastBookingDate = lastBooking ? lastBooking.start : "N/A";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${customerId}</td>
            <td>${customer.name}</td>
            <td>${customer.email}</td>
            <td>${customer.phone}</td>
            <td><span style="color: #16a34a; font-weight: bold">${totalBookings}</span></td>
            <td>${lastBookingDate}</td>
            <td><button class="btn" onclick="viewCustomerDetails('${customer.email}')">View Details</button></td>
          `;
        customersList.appendChild(row);
        customerId++;
      });
    }

    // Load users from database
    async function loadUsers() {
      try {
        const users = await window.CarRentalAPI.getUsers();
        const usersList = document.getElementById("users-list");
        usersList.innerHTML = "";

        if (users.length === 0) {
          usersList.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; color: #98a0ab; padding: 20px;">
                  No users found. Users will appear here when customers make reservations.
                </td>
              </tr>
            `;
          return;
        }

        // Display users
        users.forEach((user, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${user.id}</td>
              <td>${user.name}</td>
              <td>${user.email}</td>
              <td><span style="color: ${user.user_type === "admin" ? "#16a34a" : "#3b82f6"}">${user.user_type
            }</span></td>
              <td><button class="btn" onclick="editUser(${user.id})">Edit</button></td>
            `;
          usersList.appendChild(row);
        });
      } catch (error) {
        console.error("Failed to load users:", error);
        // Fallback to localStorage
        const usersList = document.getElementById("users-list");
        usersList.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; color: #98a0ab; padding: 20px;">
                Failed to load users. Please try again.
              </td>
            </tr>
          `;
      }
    }

    // Load cars from database
    async function loadCars() {
      try {
        const cars = await window.CarRentalAPI.getCars();
        // Load grid view
        loadCarsGrid(cars);
        // Load table view
        loadCarsTable(cars);
      } catch (error) {
        console.error("Failed to load cars:", error);
        // Fallback to localStorage
        let cars = JSON.parse(localStorage.getItem("cars") || "[]");
        if (cars.length === 0) {
          cars = [
            {
              name: "BMW i5",
              plate: "BMW-2024",
              type: "Automatic",
              category: "luxury",
              seats: 5,
              price: 5500,
              status: "available",
              image: "2024-BMW-5-Series-i5-for-China-1.jpg",
            },
            {
              name: "Mitsubishi Montero",
              plate: "MITS-777",
              type: "Automatic",
              category: "suv",
              seats: 5,
              price: 4200,
              status: "available",
              image: "mitsubishi-montero-2027.jpg",
            },
            {
              name: "Nissan Urvan",
              plate: "URV-888",
              type: "Manual",
              category: "van",
              seats: 12,
              price: 6200,
              status: "available",
              image: "Nissan-Urvan-CP063_02-scaled.webp",
            },
            {
              name: "Toyota Vios",
              plate: "VIOS-001",
              type: "Manual",
              category: "sedan",
              seats: 4,
              price: 1400,
              status: "available",
              image: "Toyota-Vios-1-https___bmwjoyfest.vn_.jpg",
            },
          ];
          localStorage.setItem("cars", JSON.stringify(cars));
        }
        loadCarsGrid(cars);
        loadCarsTable(cars);
      }
    }

    // Load cars in grid view (Customer Style)
    function loadCarsGrid(cars) {
      const carsGrid = document.getElementById("cars-grid");
      const search = document.getElementById("adminSearchBox").value.toLowerCase();
      const filter = document.getElementById("adminCategoryFilter").value;
      carsGrid.innerHTML = "";

      cars
        .filter((c) => filter === "all" || c.category === filter)
        .filter((c) => c.name.toLowerCase().includes(search) || c.plate.toLowerCase().includes(search))
        .forEach((car, index) => {
          const card = document.createElement("div");
          card.className = "car-card";
          card.style.cssText = `
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 12px;
              padding: 20px;
              transition: all 0.3s ease;
              cursor: pointer;
            `;

          card.innerHTML = `
              <div style="width:100%; height:150px; background:#374151; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:14px; margin-bottom:8px;">
                <img src="${car.image}" alt="${car.name
            }" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='🚗 Car Image'; this.parentElement.style.color='#9ca3af'; this.parentElement.style.fontSize='24px';">
              </div>
              <h4 style="margin: 8px 0; font-size: 18px; color: #e6eef6;">${car.name}</h4>
              <p style="margin: 4px 0; color: var(--muted);">Plate: ${car.plate}</p>
              <p style="margin: 4px 0; color: var(--muted);">Type: ${car.type}</p>
              <p style="margin: 4px 0; color: var(--muted);">Seats: ${car.seats}</p>
              <p style="margin: 4px 0; color: var(--accent); font-weight: bold;">₱${car.price}/day</p>
              <p style="margin: 4px 0;">Status: <b style="color:${car.status === "available" ? "#16a34a" : car.status === "reserved" ? "#3b82f6" : "#ef4444"
            }">${car.status}</b></p>
              <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <button class="btn" onclick="editCar(${index})" style="flex: 1; padding: 8px 12px; font-size: 12px;">Edit</button>
                <button class="btn" onclick="viewCarDetails(${index})" style="background: #6b7280; flex: 1; padding: 8px 12px; font-size: 12px;">Details</button>
              </div>
            `;
          carsGrid.appendChild(card);
        });
    }

    // Load cars in table view
    function loadCarsTable(cars) {
      const carsList = document.getElementById("cars-list");
      carsList.innerHTML = "";

      cars.forEach((car, index) => {
        const row = document.createElement("tr");
        let statusColor = "#16a34a"; // Default green
        if (car.status === "reserved") statusColor = "#3b82f6"; // Blue
        else if (car.status === "rented") statusColor = "#ef4444"; // Red

        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
              <img src="${car.image}" alt="${car.name
          }" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none';">
            </td>
            <td>${car.name}</td>
            <td>${car.name.split(" ")[0]}</td>
            <td>${car.type}</td>
            <td>${car.seats}</td>
            <td>₱${car.price.toLocaleString()}</td>
            <td><span style="color: ${statusColor}; font-weight: bold">${car.status}</span></td>
            <td>
              <button class="btn" onclick="editCar(${index})" style="margin-right: 5px;">Edit</button>
              <button class="btn" onclick="viewCarDetails(${index})" style="background: #6b7280;">Details</button>
            </td>
          `;
        carsList.appendChild(row);
      });
    }

    // Toggle between grid and table view
    function toggleCarView() {
      const carsGrid = document.getElementById("cars-grid");
      const carsTableView = document.getElementById("cars-table-view");
      const toggleBtn = document.querySelector('button[onclick="toggleCarView()"]');

      if (carsGrid.style.display === "none") {
        carsGrid.style.display = "grid";
        carsTableView.style.display = "none";
        toggleBtn.textContent = "📋 Switch to Table View";
      } else {
        carsGrid.style.display = "none";
        carsTableView.style.display = "block";
        toggleBtn.textContent = "🖼️ Switch to Grid View";
      }
    }

    // View car details
    function viewCarDetails(index) {
      const cars = JSON.parse(localStorage.getItem("cars") || "[]");
      const car = cars[index];

      if (!car) {
        alert("Car not found!");
        return;
      }

      let details = `Car Details:\n\n`;
      details += `Name: ${car.name}\n`;
      details += `Plate: ${car.plate}\n`;
      details += `Type: ${car.type}\n`;
      details += `Category: ${car.category}\n`;
      details += `Seats: ${car.seats}\n`;
      details += `Price: ₱${car.price.toLocaleString()}/day\n`;
      details += `Status: ${car.status}\n`;
      details += `Image: ${car.image}`;

      alert(details);
    }

    // Load rentals from localStorage (customer car rentals)
    function loadRentals() {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const rentalsList = document.getElementById("rentals-list");
      rentalsList.innerHTML = "";

      if (reservations.length === 0) {
        rentalsList.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; color: #98a0ab; padding: 20px;">
                No car rentals yet. Rentals will appear here when customers rent cars.
              </td>
            </tr>
          `;
        return;
      }

      // Filter to show only active rentals (rented, reserved, pending)
      const activeRentals = reservations.filter(
        (rental) =>
          rental.status === "rented" ||
          rental.status === "reserved" ||
          rental.status === "Pending" ||
          rental.status === "Reserved"
      );

      if (activeRentals.length === 0) {
        rentalsList.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; color: #98a0ab; padding: 20px;">
                No active rentals. Rentals will appear here when customers rent cars.
              </td>
            </tr>
          `;
        return;
      }

      activeRentals.forEach((rental, index) => {
        const row = document.createElement("tr");
        let statusColor = "#16a34a"; // Default green
        let statusText = rental.status;

        // Color coding for different statuses
        if (rental.status === "Pending") {
          statusColor = "#eab308"; // Yellow
          statusText = "Pending";
        } else if (rental.status === "Reserved" || rental.status === "reserved") {
          statusColor = "#3b82f6"; // Blue
          statusText = "Reserved";
        } else if (rental.status === "rented") {
          statusColor = "#ef4444"; // Red
          statusText = "Rented";
        } else if (rental.status === "Confirmed") {
          statusColor = "#16a34a"; // Green
          statusText = "Confirmed";
        }

        row.innerHTML = `
            <td>#RT-${1000 + index}</td>
            <td>${rental.name}</td>
            <td>${rental.car}</td>
            <td>${rental.plate || "N/A"}</td>
            <td>${rental.start}</td>
            <td>${rental.end}</td>
            <td><span style="color: ${statusColor}; font-weight: bold">${statusText}</span></td>
            <td><button class="btn" onclick="updateRental(${index})">Update</button></td>
          `;
        rentalsList.appendChild(row);
      });
    }

    // Load bookings from localStorage (customer reservations)
    function loadBookings() {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const bookingsList = document.getElementById("bookings-list");
      bookingsList.innerHTML = "";

      if (reservations.length === 0) {
        bookingsList.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: #98a0ab; padding: 20px;">
                No customer reservations yet. Reservations will appear here when customers make bookings.
              </td>
            </tr>
          `;
        return;
      }

      reservations.forEach((booking, index) => {
        const row = document.createElement("tr");
        let statusColor = "#16a34a"; // Default green
        if (booking.status === "Pending") statusColor = "#eab308"; // Yellow
        if (booking.status === "Reserved") statusColor = "#3b82f6"; // Blue

        row.innerHTML = `
            <td>#BK-${1000 + index}</td>
            <td>${booking.name}</td>
            <td>${booking.car}</td>
            <td>${booking.start}</td>
            <td>${booking.end}</td>
            <td><span style="color: ${statusColor}">${booking.status}</span></td>
            <td><button class="btn" onclick="updateBooking(${index})">Update</button></td>
          `;
        bookingsList.appendChild(row);
      });
    }

    // Admin functions
    function editUser(id) {
      alert(`Edit user with ID: ${id}`);
    }

    // Show add car modal
    function showAddCarModal() {
      document.getElementById("addCarModal").style.display = "flex";
    }

    // Close add car modal
    function closeAddCarModal() {
      document.getElementById("addCarModal").style.display = "none";
      document.getElementById("addCarForm").reset();
    }

    // Handle add car form submission
    async function addCar() {
      const form = document.getElementById("addCarForm");
      const formData = new FormData(form);

      // Get image file
      const imageFile = formData.get("image");
      let imageName = "default-car.jpg";

      // Handle image file
      if (imageFile && imageFile.size > 0) {
        // For now, we'll use the filename. In a real app, you'd upload to server
        imageName = imageFile.name;
      }

      const carData = {
        name: formData.get("name"),
        plate: formData.get("plate"),
        type: formData.get("type"),
        category: formData.get("category"),
        seats: parseInt(formData.get("seats")),
        price: parseFloat(formData.get("price")),
        status: "available",
        image: imageName,
      };

      // Validate all required fields
      if (!carData.name || !carData.plate || !carData.type || !carData.category || !carData.seats || !carData.price) {
        alert("Please fill in all required fields.");
        return;
      }

      // Validate numeric fields
      if (isNaN(carData.seats) || isNaN(carData.price)) {
        alert("Please enter valid numbers for seats and price.");
        return;
      }

      try {
        // Check if user is logged in
        if (!localStorage.getItem("userId") || !localStorage.getItem("userType")) {
          alert("Please log in first to add cars.");
          return;
        }

        console.log("Form data being sent:", carData);
        console.log("User ID:", localStorage.getItem("userId"));
        console.log("User Type:", localStorage.getItem("userType"));

        const result = await window.CarRentalAPI.createCar(carData);
        console.log("API response:", result);
        alert("Car added successfully!");
        closeAddCarModal();
        loadCars(); // Refresh the cars list
      } catch (error) {
        console.error("Failed to add car:", error);
        console.error("Error details:", error.message);

        // Fallback to localStorage
        try {
          const cars = JSON.parse(localStorage.getItem("cars") || "[]");
          carData.id = Date.now(); // Generate unique ID
          cars.push(carData);
          localStorage.setItem("cars", JSON.stringify(cars));
          alert("Car added to local storage (database connection failed)!");
          closeAddCarModal();
          loadCars();
        } catch (fallbackError) {
          console.error("Fallback failed:", fallbackError);
          alert(`Failed to add car: ${error.message || "Unknown error"}`);
        }
      }
    }

    function editCar(id) {
      alert(`Edit car with ID: ${id}`);
    }

    function updateBooking(id) {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const booking = reservations[id];

      if (booking) {
        const newStatus = prompt(
          `Update status for booking ${booking.car} (current: ${booking.status}):\n\nOptions: Pending, Reserved, Confirmed, Completed, Cancelled`
        );
        if (newStatus && ["Pending", "Reserved", "Confirmed", "Completed", "Cancelled"].includes(newStatus)) {
          reservations[id].status = newStatus;
          localStorage.setItem("reservations", JSON.stringify(reservations));
          loadBookings();
          alert("Booking status updated successfully!");
        }
      }
    }

    function updateRental(id) {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const rental = reservations[id];

      if (rental) {
        const newStatus = prompt(
          `Update status for rental ${rental.car} (current: ${rental.status}):\n\nOptions: Pending, Reserved, Confirmed, Completed, Cancelled`
        );
        if (newStatus && ["Pending", "Reserved", "Confirmed", "Completed", "Cancelled"].includes(newStatus)) {
          reservations[id].status = newStatus;
          localStorage.setItem("reservations", JSON.stringify(reservations));
          loadRentals();
          alert("Rental status updated successfully!");
        }
      }
    }

    function viewCustomerDetails(customerEmail) {
      const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      const customerBookings = reservations.filter((booking) => booking.email === customerEmail);

      if (customerBookings.length === 0) {
        alert("No reservations found for this customer.");
        return;
      }

      let details = `Customer Details:\n\n`;
      details += `Email: ${customerEmail}\n`;
      details += `Name: ${customerBookings[0].name}\n`;
      details += `Phone: ${customerBookings[0].phone || "N/A"}\n`;
      details += `Total Bookings: ${customerBookings.length}\n\n`;
      details += `Reservations:\n`;

      customerBookings.forEach((booking, index) => {
        details += `${index + 1}. ${booking.car} (${booking.start} to ${booking.end}) - ${booking.status}\n`;
      });

      alert(details);
    }

    // Dashboard functions
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('[id$="-section"]').forEach((section) => {
        section.style.display = "none";
      });

      // Remove active class from all nav items
      document.querySelectorAll(".nav-item").forEach((nav) => nav.classList.remove("active"));

      // Show selected section
      if (section === "cars") {
        document.getElementById("cars-section").style.display = "block";
        loadCars();
        // Set Cars nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Cars") nav.classList.add("active");
        });
      } else if (section === "users") {
        document.getElementById("users-section").style.display = "block";
        loadUsers();
        // Set Users nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Users") nav.classList.add("active");
        });
      } else if (section === "customers") {
        document.getElementById("customers-section").style.display = "block";
        loadCustomers();
        // Set Customers nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Customers") nav.classList.add("active");
        });
      } else if (section === "bookings") {
        document.getElementById("bookings-section").style.display = "block";
        loadBookings();
        // Set Bookings nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Bookings") nav.classList.add("active");
        });
      } else if (section === "rent") {
        document.getElementById("rent-section").style.display = "block";
        loadRentals();
        // Set Rent nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Rent") nav.classList.add("active");
        });
      } else if (section === "sales") {
        document.getElementById("bookings-section").style.display = "block";
        loadBookings();
        // Set Bookings nav item as active
        document.querySelectorAll(".nav-item").forEach((nav) => {
          if (nav.textContent.trim() === "Bookings") nav.classList.add("active");
        });
      }
    }

    async function updateDashboardStats() {
      try {
        const stats = await window.CarRentalAPI.getDashboardStats();

        document.getElementById("total-cars").textContent = stats.cars.total_cars || 0;
        document.getElementById("total-customers").textContent = stats.bookings.total_bookings || 0;
        document.getElementById("total-reservations").textContent = stats.bookings.total_bookings || 0;
        document.getElementById("total-rents").textContent = stats.bookings.pending_bookings || 0;
        document.getElementById("total-sales").textContent = `₱${(
          stats.bookings.total_revenue || 0
        ).toLocaleString()}`;
      } catch (error) {
        console.error("Failed to load dashboard stats:", error);
        // Fallback to localStorage
        const cars = JSON.parse(localStorage.getItem("cars") || "[]");
        const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
        const uniqueCustomers = new Set(reservations.map((r) => r.email)).size;

        document.getElementById("total-cars").textContent = cars.length;
        document.getElementById("total-customers").textContent = uniqueCustomers;
        document.getElementById("total-reservations").textContent = reservations.length;
        document.getElementById("total-rents").textContent = reservations.filter(
          (r) => r.status === "Pending" || r.status === "Reserved"
        ).length;

        let totalSales = 0;
        reservations.forEach((rental) => {
          const days = Math.ceil((new Date(rental.end) - new Date(rental.start)) / (1000 * 60 * 60 * 24));
          totalSales += days * parseFloat(rental.price || 0);
        });
        document.getElementById("total-sales").textContent = `₱${totalSales.toLocaleString()}`;
      }
    }

    function initializeCharts() {
      // Rental Trends Chart
      const rentalCtx = document.getElementById("rentalChart").getContext("2d");
      new Chart(rentalCtx, {
        type: "line",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
          datasets: [
            {
              label: "Rentals",
              data: [12, 19, 15, 25, 22, 30],
              borderColor: "#ef4444",
              backgroundColor: "rgba(239, 68, 68, 0.1)",
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: "#e6eef6",
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: "#98a0ab",
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)",
              },
            },
            x: {
              ticks: {
                color: "#98a0ab",
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)",
              },
            },
          },
        },
      });
    }
  </script>
</body>

</html>