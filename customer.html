<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Rental â€” Customer Page</title>
    <style>
      :root {
        --dark: #0f1724;
        --light: #ffffff;
        --gray: #d1d5db;
        --accent: #c9a227;
        /* gold highlight */
        --danger: #ef4444;
        --success: #16a34a;
        --muted: #98a0ab;
      }

      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: var(--dark);
        color: var(--light);
      }

      header {
        background: var(--accent);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--dark);
      }

      .nav-links {
        display: flex;
        gap: 15px;
      }

      .nav-links a {
        color: var(--dark);
        text-decoration: none;
        font-size: 1rem;
        padding: 5px 10px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.2);
      }

      main {
        padding: 20px;
        max-width: 1200px;
        margin: auto;
      }

      .toolbar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .toolbar input,
      .toolbar select {
        padding: 8px;
        border-radius: 6px;
        border: none;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
      }

      .car-card {
        background: #1e293b;
        padding: 12px;
        border-radius: 10px;
        text-align: center;
      }

      .car-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        background: #374151;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 14px;
      }

      .car-card h4 {
        margin: 8px 0 4px;
        color: var(--accent);
      }

      .car-card p {
        margin: 4px 0;
        font-size: 14px;
      }

      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }

      .btn-rent {
        background: var(--success);
        color: white;
      }

      .btn-cancel {
        background: var(--danger);
        color: white;
      }

      .btn-reserve {
        background: var(--accent);
        color: var(--dark);
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: #1e293b;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
      }

      .modal-content h3 {
        margin-top: 0;
        color: var(--accent);
      }

      .modal-content input {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border: none;
        border-radius: 6px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
      }

      .modal-footer button {
        margin-left: 8px;
      }

      /* Reservation table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 10px;
        text-align: left;
      }

      th {
        background: #334155;
        color: var(--accent);
      }

      tr:nth-child(even) {
        background: #273449;
      }
    </style>
    <script src="js/api.js"></script>
  </head>

  <body>
    <header>
      <div style="display: flex; align-items: center; gap: 15px">
        <div
          style="
            background: var(--accent);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
          ">
          AJ
        </div>
        <div>Welcome to AJIS Car Rental</div>
      </div>
      <div class="nav-links" style="display: flex; gap: 10px">
        <a
          href="login.html"
          onclick="logout()"
          style="background: var(--danger); color: white; text-decoration: none; padding: 8px 12px; border-radius: 6px"
          >Logout</a
        >
      </div>
    </header>
    <main>
      <!-- Search + Filter -->
      <div class="toolbar" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap">
        <input
          type="text"
          id="searchBox"
          placeholder="Search cars..."
          style="
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #e6eef6;
          " />
        <select
          id="categoryFilter"
          style="
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #e6eef6;
          ">
          <option value="all">All Categories</option>
          <option value="sedan">Sedan</option>
          <option value="suv">SUV</option>
          <option value="van">Van</option>
          <option value="luxury">Luxury</option>
        </select>
      </div>

      <!-- Car Grid (Admin Style) -->
      <div
        id="carsGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 20px;
          margin-bottom: 20px;
        "></div>

      <!-- Reservations -->
      <h3 style="margin-top: 40px; color: var(--accent)">My Reservations</h3>
      <table>
        <thead>
          <tr>
            <th>Car</th>
            <th>Dates</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="reservationsTable"></tbody>
      </table>
    </main>

    <!-- Rent Modal -->
    <div class="modal" id="rentModal">
      <div class="modal-content">
        <h3>Rent Car</h3>
        <input type="text" id="custName" placeholder="Full Name" />
        <input type="email" id="custEmail" placeholder="Email" />
        <input type="tel" id="custPhone" placeholder="Phone Number" />
        <input type="date" id="rentStart" />
        <input type="date" id="rentEnd" />
        <div class="modal-footer">
          <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
          <button class="btn btn-rent" onclick="confirmRent()">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Reserve Modal -->
    <div class="modal" id="reserveModal">
      <div class="modal-content">
        <h3>Reserve Car</h3>
        <input type="text" id="reserveName" placeholder="Full Name" />
        <input type="email" id="reserveEmail" placeholder="Email" />
        <input type="tel" id="reservePhone" placeholder="Phone Number" />
        <input type="date" id="reserveStart" />
        <input type="date" id="reserveEnd" />
        <div class="modal-footer">
          <button class="btn btn-cancel" onclick="closeReserveModal()">Cancel</button>
          <button class="btn btn-reserve" onclick="confirmReserve()">Reserve</button>
        </div>
      </div>
    </div>

    <script>
      // Default Cars (sample data)
      const cars = [
        {
          name: "BMW i5",
          plate: "BMW-2024",
          type: "Automatic",
          category: "luxury",
          seats: 5,
          price: 5500,
          status: "available",
          image: "2024-BMW-5-Series-i5-for-China-1.jpg",
        },
        {
          name: "Mitsubishi Montero",
          plate: "MITS-777",
          type: "Automatic",
          category: "suv",
          seats: 5,
          price: 4200,
          status: "available",
          image: "mitsubishi-montero-2027.jpg",
        },
        {
          name: "Nissan Urvan",
          plate: "URV-888",
          type: "Manual",
          category: "van",
          seats: 12,
          price: 6200,
          status: "available",
          image: "Nissan-Urvan-CP063_02-scaled.webp",
        },
        {
          name: "Toyota Vios",
          plate: "VIOS-001",
          type: "Manual",
          category: "sedan",
          seats: 4,
          price: 1400,
          status: "available",
          image: "Toyota-Vios-1-https___bmwjoyfest.vn_.jpg",
        },
      ];

      let reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
      let selectedCar = null;

      // Preload images to ensure they're accessible
      function preloadImages() {
        cars.forEach((car) => {
          const img = new Image();
          img.src = car.image;
          img.onload = () => {
            console.log(`Image loaded: ${car.image}`);
          };
          img.onerror = () => {
            console.log(`Image failed to load: ${car.image}`);
          };
        });
      }

      function renderCars() {
        const grid = document.getElementById("carsGrid");
        const search = document.getElementById("searchBox").value.toLowerCase();
        const filter = document.getElementById("categoryFilter").value;
        grid.innerHTML = "";

        // Always load cars from localStorage to get the latest status
        const storedCars = JSON.parse(localStorage.getItem("cars") || "[]");
        if (storedCars.length > 0) {
          // Update the global cars array with stored data
          cars.length = 0;
          cars.push(...storedCars);
        } else {
          // If no stored cars, save the default cars to localStorage
          localStorage.setItem("cars", JSON.stringify(cars));
        }

        cars
          .filter((c) => filter === "all" || c.category === filter)
          .filter((c) => c.name.toLowerCase().includes(search) || c.plate.toLowerCase().includes(search))
          .forEach((c, i) => {
            const card = document.createElement("div");
            card.className = "car-card";
            card.style.cssText = `
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 12px;
              padding: 20px;
              transition: all 0.3s ease;
              cursor: pointer;
            `;

            card.innerHTML = `
              <div style="width:100%; height:150px; background:#374151; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:14px; margin-bottom:8px;">
                <img src="${c.image}" alt="${
              c.name
            }" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='ðŸš— Car Image'; this.parentElement.style.color='#9ca3af'; this.parentElement.style.fontSize='24px';">
              </div>
              <h4 style="margin: 8px 0; font-size: 18px; color: #e6eef6;">${c.name}</h4>
              <p style="margin: 4px 0; color: var(--muted);">Plate: ${c.plate}</p>
              <p style="margin: 4px 0; color: var(--muted);">Type: ${c.type}</p>
              <p style="margin: 4px 0; color: var(--muted);">Seats: ${c.seats}</p>
              <p style="margin: 4px 0; color: var(--accent); font-weight: bold;">â‚±${c.price}/day</p>
              <p style="margin: 4px 0;">Status: <b style="color:${
                c.status === "available" ? "#16a34a" : c.status === "reserved" ? "#3b82f6" : "#ef4444"
              }">${c.status}</b></p>
              ${
                c.status === "available"
                  ? `
                <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                  <button class="btn btn-rent" onclick="openModal(${i})" style="flex: 1; padding: 8px 12px; font-size: 12px;">Rent</button>
                  <button class="btn btn-reserve" onclick="openReserveModal(${i})" style="flex: 1; padding: 8px 12px; font-size: 12px;">Reserve</button>
                </div>
              `
                  : ""
              }
            `;
            grid.appendChild(card);
          });
      }

      function renderReservations() {
        const table = document.getElementById("reservationsTable");
        table.innerHTML = "";
        reservations.forEach((r, i) => {
          table.innerHTML += `
          <tr>
            <td>${r.car}</td>
            <td>${r.start} â†’ ${r.end}</td>
            <td><b style="color:var(--accent)">${r.status}</b></td>
            <td><button class="btn btn-cancel" onclick="cancelReservation(${i})">Cancel</button></td>
          </tr>
        `;
        });
      }

      function openModal(index) {
        selectedCar = cars[index];
        document.getElementById("rentModal").style.display = "flex";
      }
      function closeModal() {
        document.getElementById("rentModal").style.display = "none";
      }

      function openReserveModal(index) {
        selectedCar = cars[index];
        document.getElementById("reserveModal").style.display = "flex";
      }
      function closeReserveModal() {
        document.getElementById("reserveModal").style.display = "none";
      }

      function confirmRent() {
        const name = document.getElementById("custName").value.trim();
        const email = document.getElementById("custEmail").value.trim();
        const phone = document.getElementById("custPhone").value.trim();
        const start = document.getElementById("rentStart").value;
        const end = document.getElementById("rentEnd").value;

        if (!name || !email || !phone || !start || !end) {
          alert("Fill all fields!");
          return;
        }

        // Change the car status to rented
        const carIndex = cars.findIndex((car) => car.name === selectedCar.name);
        if (carIndex !== -1) {
          cars[carIndex].status = "rented";
        }

        reservations.push({
          car: selectedCar.name,
          plate: selectedCar.plate,
          seats: selectedCar.seats,
          type: selectedCar.type,
          price: selectedCar.price,
          status: "Pending",
          name,
          email,
          phone,
          start,
          end,
        });

        // Save updated cars and reservations to localStorage
        localStorage.setItem("cars", JSON.stringify(cars));
        localStorage.setItem("reservations", JSON.stringify(reservations));

        // Dispatch custom events for admin page
        window.dispatchEvent(new CustomEvent("carStatusChanged"));
        window.dispatchEvent(new CustomEvent("reservationAdded"));

        closeModal();
        renderCars(); // Re-render cars to show updated status
        renderReservations();
        alert("Reservation submitted!");
      }

      function confirmReserve() {
        const name = document.getElementById("reserveName").value.trim();
        const email = document.getElementById("reserveEmail").value.trim();
        const phone = document.getElementById("reservePhone").value.trim();
        const start = document.getElementById("reserveStart").value;
        const end = document.getElementById("reserveEnd").value;

        if (!name || !email || !phone || !start || !end) {
          alert("Fill all fields!");
          return;
        }

        // Change the car status to reserved
        const carIndex = cars.findIndex((car) => car.name === selectedCar.name);
        if (carIndex !== -1) {
          cars[carIndex].status = "reserved";
        }

        reservations.push({
          car: selectedCar.name,
          plate: selectedCar.plate,
          seats: selectedCar.seats,
          type: selectedCar.type,
          price: selectedCar.price,
          status: "Reserved",
          name,
          email,
          phone,
          start,
          end,
        });

        // Save updated cars and reservations to localStorage
        localStorage.setItem("cars", JSON.stringify(cars));
        localStorage.setItem("reservations", JSON.stringify(reservations));

        // Dispatch custom events for admin page
        window.dispatchEvent(new CustomEvent("carStatusChanged"));
        window.dispatchEvent(new CustomEvent("reservationAdded"));

        closeReserveModal();
        renderCars(); // Re-render cars to show updated status
        renderReservations();
        alert("Car reserved successfully!");
      }

      function cancelReservation(index) {
        if (confirm("Are you sure you want to cancel this reservation?")) {
          const reservation = reservations[index];

          // Change the car status back to available
          const carIndex = cars.findIndex((car) => car.name === reservation.car);
          if (carIndex !== -1) {
            cars[carIndex].status = "available";
          }

          reservations.splice(index, 1);

          // Save updated cars and reservations to localStorage
          localStorage.setItem("cars", JSON.stringify(cars));
          localStorage.setItem("reservations", JSON.stringify(reservations));

          // Dispatch custom events for admin page
          window.dispatchEvent(new CustomEvent("carStatusChanged"));
          window.dispatchEvent(new CustomEvent("reservationAdded"));

          renderCars(); // Re-render cars to show updated status
          renderReservations();
          alert("Reservation cancelled.");
        }
      }

      document.getElementById("searchBox").addEventListener("input", renderCars);
      document.getElementById("categoryFilter").addEventListener("change", renderCars);

      // Logout function
      function logout() {
        localStorage.removeItem("userId");
        localStorage.removeItem("userType");
        localStorage.removeItem("userName");
        localStorage.removeItem("isLoggedIn");
        window.location.href = "login.html";
      }

      // Initialize the page
      preloadImages();

      // Load initial data from localStorage
      const storedCars = JSON.parse(localStorage.getItem("cars") || "[]");
      if (storedCars.length > 0) {
        cars.length = 0;
        cars.push(...storedCars);

        // Reset any "rented" cars to "available" if needed
        let needsUpdate = false;
        cars.forEach((car) => {
          if (car.status === "rented") {
            car.status = "available";
            needsUpdate = true;
          }
        });

        if (needsUpdate) {
          localStorage.setItem("cars", JSON.stringify(cars));
        }
      }

      renderCars();
      renderReservations();
    </script>
  </body>
</html>
